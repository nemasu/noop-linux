#!/bin/bash

AUFS_BRANCH=aufs4.0

set -e
if [ -z "$1" ];
then
	echo "Need a URL for source"
fi
pkgr -i git &> /dev/null
pkgr -i bc &> /dev/null

BLDRTMPDIR=/tmp/bldr
VERSION=`echo $1 | sed 's/.*linux-//g; s/\.tar\.xz//g'`
mkdir -p $BLDRTMPDIR
cd /usr/src

if [ ! -e linux-$VERSION ];
then
	if [ ! -e /tmp/linux-$VERSION.tar.xz ];
	then
		wget $1 -O/tmp/linux-$VERSION.tar.xz
	fi
	tar xf /tmp/linux-$VERSION.tar.xz

	git clone -b ${AUFS_BRANCH} https://github.com/sfjro/aufs4-standalone.git
	cd linux-$VERSION
	patch -Np1 -i ../aufs4-standalone/aufs4-kbuild.patch
	patch -Np1 -i ../aufs4-standalone/aufs4-base.patch
	patch -Np1 -i ../aufs4-standalone/aufs4-mmap.patch
	#patch -Np1 -i ../aufs4-standalone/aufs4-standalone.patch
	cp -vr ../aufs4-standalone/fs .
	cp -v ../aufs4-standalone/include/uapi/linux/aufs_type.h include/uapi/linux/
	echo "header-y += aufs_type.h" >> include/uapi/linux/Kbuild
	cd ..
	rm -rf aufs4-standalone

fi

cd linux-$VERSION

if [ ! -e .config ];
then
	if [ `uname -m` == "x86_64" ];
	then
		wget https://raw.githubusercontent.com/nemasu/noop-linux/master/etc/config64 -O.config
	fi
	
	echo "CONFIG_AUFS_FS=y" >> .config
	echo "CONFIG_AUFS_BRANCH_MAX_127=y" >> .config
	echo "# CONFIG_AUFS_BRANCH_MAX_511 is not set" >> .config
	echo "# CONFIG_AUFS_BRANCH_MAX_1023 is not set" >> .config
	echo "# CONFIG_AUFS_BRANCH_MAX_32767 is not set" >> .config
	echo "CONFIG_AUFS_SBILIST=y" >> .config
	echo "# CONFIG_AUFS_HNOTIFY is not set" >> .config
	echo "# CONFIG_AUFS_EXPORT is not set" >> .config
	echo "# CONFIG_AUFS_RDU is not set" >> .config
	echo "# CONFIG_AUFS_PROC_MAP is not set" >> .config
	echo "# CONFIG_AUFS_SP_IATTR is not set" >> .config
	echo "# CONFIG_AUFS_SHWH is not set" >> .config
	echo "CONFIG_AUFS_BR_RAMFS=y" >> .config
	echo "# CONFIG_AUFS_BR_FUSE is not set" >> .config
	echo "# CONFIG_AUFS_BR_HFSPLUS is not set" >> .config
	echo "CONFIG_AUFS_BDEV_LOOP=y" >> .config
	echo "# CONFIG_AUFS_DEBUG is not set" >> .config
	echo "CONFIG AUFS_FHSM=y" >> .config


fi

rm -rf /root/noopkern
mkdir -p /root/noopkern/boot
mkdir -p /root/noopfirm
mkdir -p /root/noophead/usr

make -j3
cp -v arch/x86/boot/bzImage /root/noopkern/boot/vmlinuz-$VERSION

make INSTALL_MOD_PATH=/root/noopkern modules_install

make INSTALL_HDR_PATH=/root/noophead/usr headers_install

cd /root/noopkern

#This is in linux-firmware
rm -rf lib/firmware

if [ `echo $VERSION | sed -e 's/\./\n/g' | wc -l` -eq 2 ];
then
	depmod -F /usr/src/linux-${VERSION}/System.map -a -b /root/noopkern -E /usr/src/linux-${VERSION}/Module.symvers "${VERSION}.0"
else
	depmod -F /usr/src/linux-${VERSION}/System.map -a -b /root/noopkern -E /usr/src/linux-${VERSION}/Module.symvers ${VERSION}
fi

wget https://raw.githubusercontent.com/nemasu/noop-linux/master/etc/kbldr-preup -O$BLDRTMPDIR/preup
wget https://raw.githubusercontent.com/nemasu/noop-linux/master/etc/kbldr-postup -O $BLDRTMPDIR/postup

pkgr -genmeta linux-kernel ${VERSION}
pkgr -genpkg

mv *.pkg /root/bldr-done

cd /root/noophead

pkgr -genmeta linux-headers ${VERSION}
pkgr -genpkg

mv *.pkg /root/bldr-done

cd /root/noopfirm

git clone git://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git
cd linux-firmware
git archive --format=tar --prefix linux-firmware-$(date +%Y%m%d)/ master | bzip2 -9 > /tmp/linux-firmware-$(date +%Y%m%d).tar.bz2
cd ..
rm -rf *
mkdir -p lib/firmware

mkdir -p /tmp/noopfirmtmp && cd /tmp/noopfirmtmp && rm -rf *
tar xf /tmp/linux-firmware-$(date +%Y%m%d).tar.bz2
cd `ls`

cp -a * /root/noopfirm/lib/firmware/
rm -rf /tmp/linux-firmware-$(date +%Y%m%d).tar.bz2

cd /root/noopfirm

pkgr -genmeta linux-firmware $(date +%Y%m%d)
pkgr -genpkg

mv *.pkg /root/bldr-done

rm -rf /tmp/noopfirmtmp
cd /root
rm -rf noopfirm/ noopkern/ noophead/
echo Done!
