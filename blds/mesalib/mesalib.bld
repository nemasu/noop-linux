#package name
NAME=mesalib

#Description
DESC="An open-source implementation of the OpenGL specification"

#package version
VERSION=18.0.3
DVERSION=18.0.3

#directory locations, 99.99% of the time this is 1
ISUSR=1

#source location (used by wget)
#SRC=ftp://ftp.freedesktop.org/pub/mesa/${VERSION}/MesaLib-${VERSION}.tar.bz2
SRC=https://mesa.freedesktop.org/archive/mesa-${DVERSION}.tar.xz

#extra parameters to pass to configure (if not ISSPECIAL)
EXTRACONF=

#1 if BuildAndInstall should be called instead of ./configure && make && make install method
BUILD=custom

# build/package dependancies
DEPS=('libclc' 'elfutils' 'expat' 'gcc-libs' 'glibc' 'libX11' 'libXau' 'libXdamage' 'libXdmcp' 'libXext' 'libXfixes' 'libXv' 'libXvMC' 'libXxf86vm' 'libdrm' 'libffi' 'libomxil-bellagio' 'libpciaccess' 'libunwind' 'libxcb' 'libxshmfence' 'llvm-libs' 'wayland' 'zlib')

# 'no' to skip calls to strip
STRIP=

#array of deps to add to package (ones that are not automatically picked up by pkgr)
PKGDEPS=('libclc')

#1 to restore libdb to what it was before pkgr -genmeta is called ( ie. ignore libs )
RESTORELIBDB=

export PKG_CONFIG_PATH=/lib/pkgconfig:/usr/lib/pkgconfig

function BuildAndInstall
{

        if [ "${ARCH}" == "armv6l" ];
        then
                GALLIUM_DRIVERS=swrast
                DRI_DRIVERS=swrast
        EGL_PLATFORMS=
        else
                GALLIUM_DRIVERS="r300,r600,radeonsi,nouveau,svga,swrast,virgl" 
                DRI_DRIVERS="i915,i965,r200,radeon,nouveau,swrast"
        EGL_PLATFORMS="x11,wayland,drm"
                ARCHCONF="--enable-opencl --enable-opencl-icd --enable-xa"
        fi

    ./configure \
        --prefix=/usr \
        --sysconfdir=/etc \
        --with-clang-libdir=/usr/lib \
        --with-gallium-drivers=${GALLIUM_DRIVERS} \
        --with-dri-drivers=${DRI_DRIVERS} \
        --with-egl-platforms=${EGL_PLATFORMS} \
        --enable-llvm \
        --enable-llvm-shared-libs \
        --enable-egl \
        --enable-shared-glapi \
        --enable-gbm \
        --enable-glx-tls \
        --enable-xa \
        --enable-nine \
        --enable-opencl \
        --enable-opencl-icd \
        --enable-dri \
        --enable-glx \
        --enable-osmesa \
        --enable-gles1 \
        --enable-gles2 \
        --enable-texture-float \
        --enable-dri3 \
        --enable-omx-bellagio \
        --enable-vdpau ${ARCHCONF}
        
    make -j${BLDR_CORES}
    make DESTDIR=/root/bldr-inst install

}

#Default HTTP curl new version detection
function Detect
{
        LATEST=`curl -L -s https://mesa.freedesktop.org/archive/ | egrep "mesa-[0-9\.]+\.tar\.xz" | tail -n1 | sed -e 's/.*mesa-\([0-9\.]*\)\.tar\.xz.*/\1/g'`

        vercomp $VERSION $LATEST
        if [ $? -eq 2 ];
        then
                        echo "$NAME: New Version Available! - $LATEST"
        fi
}
